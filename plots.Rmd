---
title: "Assignment 6: Oscar data"
author: 
- Jinrui Du S3506401, Thi Kim Oanh Nguyen S3451887
output: pdf_document
df_print: paged
---

# Introduction

In this report, we aim to investigate the effect of Oscar win on the survival of actors and actresses. In an earlier analysis, Redelmeier and Singh (2001) concluded that Oscar win prolonged the survival. Unfortunately, they did not incorporate the winning of an Oscar as a time-dependent variable. We will first explore the data set, then apply data stratification, Kaplan-Meier estimation, log-rank test, and Cox proportional hazards model to analyze the survival of actors.

# Import packages

```{r, message=FALSE, warning=FALSE}
rm(list = ls())
library(survival)
library(tidyverse)
library(survminer)
library(gtsummary)
```

# 1. Data exploration

The Oscar data originated from the aforementioned analysis.

```{r}
data = read.table("Oscars.txt", header = T, sep = "\t")

# Verify that each row corresponding to a person.
all(table(data$Identity) == 1)

# Create variable Death from Alive.
data$Death = ifelse(data$Alive == 1, 0, 1)

# Create the time to event.
data$Age = data$Final - data$Birth

# Create binary variable Oscar_win 
data$Oscar_win = ifelse(data$Wins > 0, 1, 0)

# Create binary variable Oscar_nom
data$Oscar_nom = ifelse(data$Noms > 0, 1, 0)

# Summary of data 
summary(data)
```

The data has information of 1670 actors spanned across 11 variables. It contains their year of birth, year of death or last known to be alive (i.e. 2001), from the two we get their age. We also get an indicator variable showing if the death was censored. The year of first Oscar win is also in the data set. Other variables are the number of films, born in USA, gender, number of Oscar nomination, number of Oscar wins, and the year of first Oscar nomination.


## Frequency table of the number of deaths

```{r}
death_table = table(data$Death)
death_df = as.data.frame(death_table)
names(death_df) = c("Death", "Frequency")
ggplot(death_df, aes(x = Death, y = Frequency, fill = as.factor(Death))) +
  geom_bar(stat = "identity") +
    labs(title = "Frequency of Deaths") +
  geom_text(aes(label = Frequency), vjust = -0.5, color = "red", size = 4) + # Add count values
  scale_fill_manual(values = c("blue", "grey"), labels = c("Alive", "Dead")) +
  scale_x_discrete(labels = c("0" = "Alive", "1" = "Dead")) +
  theme(legend.position = "none")
```
The numbers of dead and alive actors up to 2001 are close. 


## Frequency table of the number of nominations

```{r}
nom_table = table(data$Noms)
nom_df = as.data.frame(nom_table)
names(nom_df) = c("Nomination", "Frequency")
ggplot(nom_df, aes(x = Nomination, y = Frequency, fill = as.factor(Nomination))) +
  geom_bar(stat = "identity") +
    labs(title = "Frequency of Nomination", x = "Number of Nominations") +
  geom_text(aes(label = Frequency), vjust = -0.5, color = "red", size = 4) +
  theme(legend.position = "none")
```

The frequency deceases as the number of nomination increases. Most (902) actors haven't been nominated. 496 actors have one nomination. Two actors have eleven, and another two actors have twelve nominations.

## Frequency table of the number of wins

```{r}
win_table = table(data$Wins)
win_df = as.data.frame(win_table)
names(win_df) = c("Wining_Oscar", "Frequency")
ggplot(win_df, aes(x = Wining_Oscar, y = Frequency, fill = as.factor(Wining_Oscar))) +
  geom_bar(stat = "identity") +
    labs(title = "Frequency of  Wining Oscar", x = "Number of Wins") +
  geom_text(aes(label = Frequency), vjust = -0.5, color = "red", size = 4) +
  theme(legend.position = "none")
```
There are 1670 observations but 1431 of them have zero Oscar win. We have huge imbalance in the data set. It is worth noting that there is one four-time Oscar winners.

## Frequency table of gender

```{r}
gender_table = table(data$Male)
gender_df = as.data.frame(gender_table)
names(gender_df) = c("Gender", "Frequency")
ggplot(gender_df, aes(x = Gender, y = Frequency, fill = as.factor(Gender))) +
  geom_bar(stat = "identity") +
    labs(title = "Frequency of Gender") +
  geom_text(aes(label = Frequency), vjust = -0.5, color = "red", size = 4) + # Add count values
  scale_fill_manual(values = c("pink","lightblue"), labels = c("Female", "Male")) +
  scale_x_discrete(labels = c("0" = "Female", "1" = "Male")) +
  theme(legend.position = "none")
```
The difference in the numbers of male and female actors are not big. There are more actors than actresses.

## Frequency table of USA born

```{r}
born_table = table(data$Born_USA)
born_df = as.data.frame(born_table)
names(born_df) = c("Born_USA", "Frequency")
ggplot(born_df, aes(x = Born_USA, y = Frequency, fill = as.factor(Born_USA))) +
  geom_bar(stat = "identity") +
    labs(title = "Frequency of Born in USA", x = "Born in USA") +
  geom_text(aes(label = Frequency), vjust = -0.5, color = "red", size = 4) + # Add count values
  scale_fill_manual(values = c("darkgreen", "orange"), labels = c("No", "Yes")) +
  scale_x_discrete(labels = c("0" = "No", "1" = "Yes")) + 
  theme(legend.position = "none")
```
The number of US-born actors is 2.5 times the non-US-born actors in the data set.


## Frequency table of number of films
```{r}
hist(data$Films,
     breaks = seq(0, 300, by = 10), 
     main = "Distribution of Film Counts", 
     xlab = "Film Counts", 
     ylab = "Frequency")
```

It is surprising to see that there are actors can have more than 250 films in his/her lifetime.



# 2. Kaplan-Meier curve for overall survival, mean survival time, and comparing survival of actors and actresses.

## 2.1 Overall survival

We plot the Kaplan-Meier curve for all the actors in the data set.

```{r, message=FALSE, warning=FALSE}
sf_overall = survfit(formula = Surv(Age, Death) ~ 1, data = data)

ggsurvplot(sf_overall,
           data=data,
           xlim = c(0,110),
           pval = FALSE, 
           conf.int = FALSE,
           surv.median.line = "hv", # Specify median survival
           ggtheme = theme_bw(), 
           palette =c("#E7B800", "#2E9FDF"),
           xlab="Age in years") + 
  labs(color = "Groups")
```
The survival curve looks stable during the first 30 to 50 years, and start to drop after that. The median survival age is 79.


### Calculate mean survival time

To calculate the mean survival time, we first see if the last entry in the data set is censored.

```{r}
tail(data[order(data$Age), ])
```

The last record in the data set is censored. Therefore, to calculate the mean survival time, we need to choose an upper limit. If we choose the upper limit to be the maximum age, i.e. 104, in the data set, then the mean survival time is $\int_0^{104} \hat S(t) dt = 76.6$.

```{r}
mu = sf_overall$time[1]
for(i in 1:(length(sf_overall$time)-1)) {
  mu <- mu + sf_overall$surv[i] * (sf_overall$time[i+1] - sf_overall$time[i])
}

summary(sf_overall)$table["rmean"]
```

If we choose the upper limit to be the largest possible age a person can survive, i.e. 120, then the mean survival time is $\int_0^{120} \hat S(t) dt = 76.8$.

```{r}
print(sf_overall, print.rmean=TRUE, rmean=120)
```

## 2.2 Survival - males and females
Now we stratify the data set by gender, and plot the Kaplan-Meier curve.

### Kaplan-Meier curve

```{r, message=F, warning=F}
sf_gender = survfit(formula = Surv(Age, Death) ~ Male, data = data)
ggsurvplot(sf_gender,
           data = data,
           xlim = c(0,110),
           pval = FALSE, 
           conf.int = FALSE,
           surv.median.line = "hv", # Specify median survival
           ggtheme = theme_bw(), 
           palette = c("#E7B800", "#2E9FDF"),
           xlab="Age in years") + 
  labs(color = "Groups")
```
The female survival curve, which is the yellow one, runs above the male curve, starting from age 67 or so.

### Log-rank test

```{r}
survdiff(Surv(Age, Death) ~ Male, data = data)
```

The log-rank test result indicates a significant difference in survival rates between males and females. The p-value of the test is very small (5e-04), indicating sufficient evidence to reject the null hypothesis of no difference between the two groups.

### Cox proportional hazards model and hazard ratio

```{r ,message=FALSE, warning=FALSE}
model = coxph(Surv(Age, Death) ~ Male, data = data)
tbl_regression(model, exp = TRUE)
```
The p-value of the hazard ratio is less than 0.001. Male actors are $exp(0.25) = 1.29$ times likely to die than the female actors at any given age provided that they have survived to that age. 


# 3. Oscar win and nomination as time-fixed variables

We now compare the actors with at least one Oscar win and the group with no wins, using Oscar win as a time-fixed variable.

## 3.1 Oscar win
```{r, message=FALSE, warning=FALSE}
sf_win <- survfit(formula=Surv(Age, Death) ~ Oscar_win, data=data)
ggsurvplot(sf_win, 
           data = data,
           xlim = c(0,110),
           pval = FALSE, 
           conf.int = FALSE,
           surv.median.line = "hv", # Specify median survival
           ggtheme = theme_bw(), 
           palette = c("#00008B",'#FF0000'),
           xlab="Age in years") + 
  labs(color = "Groups")
```
The red survival curve is Oscar win group, which is above the blue non-win group. Looks like actors with Oscar win lives longer than those without Oscar win.

### Log-rank test
```{r}
survdiff(Surv(Age, Death) ~ Oscar_win, data = data)
```
The p-value of the log-rank test is 0.005. We reject the null hypothesis that the survival of the two groups are the same.

### Cox proportional hazards model and hazard ratio

```{r}
model2 = coxph(Surv(Age, Death) ~ Oscar_win, data = data)
tbl_regression(model2, exp = TRUE) 
```


The p-value of the hazard ratio is 0.006. At any age the actor/ actress with Oscar awards is as 0.75 times likely to die as those without Oscar awards, provided that they survived to that age.

## 3.2 Oscar nomination

We now compare the actors with at least one Oscar nomination and the group with no nominations, using Oscar nomination as a time-fixed variable.

```{r, warning=FALSE, message=FALSE}
sf_nom = survfit(Surv(Age, Death) ~ Oscar_nom, data = data)
ggsurvplot(sf_nom,
           data = data,
           xlim = c(0,110),
           pval = FALSE, conf.int = FALSE,
           surv.median.line = "hv", # Specify median survival
           ggtheme = theme_bw(), 
           palette =c( "#2E9FDF", "#E7B800"),
           xlab="Age in Years") + 
  labs(color = "Groups")
```
It looks like the survival curve of Oscar nomination group is above the non-nomination group from around age 55 to 80, but is the difference significant? We test it with the log-rank test. 

### Log-rank test
```{r}
survdiff(Surv(Age, Death) ~ Oscar_nom, data = data)
```

The p-value of the log-rank test is 0.053. We can not reject the null hypothesis that the survival of the two groups are the same.

### Cox proportional hazards model

```{r}
model3 = coxph(Surv(Age, Death) ~ Oscar_nom, data = data)
tbl_regression(model3, exp = TRUE) 
```

At any given age, the actor/ actress with nomination is as 0.87 time likely to die as without nomination, provided that they survived to that age. However, the p-value is larger than 0.05. So the ratio is not statistically significant.

# 4. The reason that above analysis is wrong.

By using Oscar win as a time-fixed variable, we treat the actors with Oscar win as if they were born with an Oscar, but they are not. They have to live long enough to get an Oscar. Therefore, analyzing the data this way, we will over-estimate the survival of the actors who won the award. This is known as "immortal time bias". This bias will increase the difference of survival between the two groups. We also did not adjust for the covariates, such as born in US, or gender. 

To conduct the correct analysis, we should use Oscar win as time-dependent variable, and also try to adjust for possible confounders.


# 5. Oscar win as time-dependent variable

To use it as a time-dependent variable, we first transform our data from wide format to long format:
```{r}
data$FirstWin_Age = data$FirstWin_Year - data$Birth
data$Time1 = 0
data$Time2 = data$Age

data_temp = data[!is.na(data$FirstWin_Year), ]
data_temp$Time2 = data_temp$FirstWin_Age
data_temp$Oscar_win = 0
data_temp$Death = 0

data[!is.na(data$FirstWin_Year), "Time1"] = data[!is.na(data$FirstWin_Year), "FirstWin_Age"]

data = rbind(data, data_temp)
data = data[order(data$Identity, data$Time1), ]
```

We take a look at a few entries of the transformed data:
```{r}
data[11:15, c("Identity", "Time1", "Time2", "FirstWin_Age", "Oscar_win", "Death")]
```

## 5.1 Single variate Cox regression

Now that the data is long format, meaning that we treat Oscar win as a time dependent variable, we can conduct our analysis as before.

### Kaplan-Meier curve

```{r, warning=FALSE, message=FALSE}
sf_win = survfit(Surv(Age, Death) ~ Oscar_win, data = data)
ggsurvplot(sf_win, 
           data = data,
           xlim = c(0,110),
           pval = FALSE, 
           conf.int = FALSE,
           surv.median.line = "hv", # Specify median survival
           ggtheme = theme_bw(), 
           palette = c("#00008B",'#FF0000'),
           xlab="Age in years") + 
  labs(color = "Groups")
```
It looks like survival curve of the Oscar win group is above the curve of the non-win group in some time intervals, but overall, the difference is not big. We use the log-rank test, and Cox proportional hazard model to confirm this.

### Log-rank test

```{r}
survdiff(Surv(Age, Death) ~ Oscar_win, data = data)
```
The p-value of the log-rank test is way above 0.05. We can not reject the null hypothesis that the survival of actors with Oscar award.

### Cox proportional hazards model

```{r}
model4 = coxph(Surv(Time1, Time2, Death) ~ Oscar_win, data = data)
tbl_regression(model4, exp = TRUE) 
```

## 5.2 Multivariate Cox regression

```{r}
model5 = coxph(Surv(Time1, Time2, Death) ~ Oscar_win + Born_USA + Male, data = data)
tbl_regression(model5, exp = TRUE) 
```

